<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
<!--  <title>Losowanie Osoby z Firebase</title>-->
  <title>Losowanie Wigilia 2024</title>
  <style>
    .body-losowanie {
      font-family: 'Arial', sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      flex-direction: column;
    }
    select {
      padding: 10px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
      max-width: 300px; /* Dostosuj szerokość do swoich potrzeb */
    }
    button {
      margin: 20px;
      padding: 10px 20px;
    }

    /* Dodaj styl dla obrazka maszyny */
    #maszyna {
      display: none; /* Ukryj na początku */
    }
    #wylosowaneZdjecie {
      display: none; /* Ukryj na początku */
      max-width: 300px; /* Dostosuj szerokość zdjęcia */
      margin-top: 20px;
    }
    #losujBtn {
      background-color: #DC3545;
      display: none;
    }
    #dalejBtn {
      background-color: #28A745;
    }
    #loginForm {
      border: 1px solid #ddd;
      padding: 10px;
      width: 300px;
      background-color: #f9f9f9;
    }
    #zalogujBtn {
      display: none;
    }
    #inputContainer input {
      display: block;
      margin: 5px 0;
    }
  </style>
</head>
<body>
<button id="zalogujBtn" onclick="openLoginForm()">Zaloguj się</button>
<div id="loginForm" style="display:none;">
  <form>
    <label for="email_field">Login:</label><br>
    <input type="text" id="email_field" name="username"><br>
    <label for="password_field">Hasło:</label><br>
    <input type="password" id="password_field" name="password"><br>
    <input type="button" onclick="login()" value="Zaloguj się">
  </form>
</div>
<div id="addForm" style="display:none;">
  <select id="collectionSelect">
    <option value="osobylosujace">Osoby Losujące</option>
    <option value="osobydolosowania">Osoby Do Losowania</option>
    <option value="all">Obydwie kolekcje</option>
  </select>
  <button id="addInputBtn">Dodaj osobę</button>
  <div id="inputContainer"></div>
  <button id="saveBtn">Zapisz</button>
</div>
<div id="losowanieMain" class="body-losowanie">
<!--  <h1 id="hiddenText">Losowanie Osoby</h1>-->
  <h1 id="hiddenText">Losowanie Wigilia 2024</h1>
  <h3 id="selectSelf">Wybierz siebie</h3>
  <select id="osobySelect"></select>
  <button id="dalejBtn">Dalej</button>
  <img src="https://www.us-lotterypowerball.com/images/play_machine.gif" alt="Maszyna" id="maszyna">

  <button id="losujBtn">Losuj osobę</button>
  <p id="wynik"></p>

  <img src="https://media.istockphoto.com/id/1001563468/photo/headshot-of-handsome-surprised-black-man-looking-at-the-camera-astonished-with-big-sale.jpg?s=612x612&w=0&k=20&c=A4NX72cahXi5lxXiNL03JwDh2JJEwsfhafmJqlwx504=" alt="Wylosowane Zdjęcie" id="wylosowaneZdjecie">
</div>


<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
  // Konfiguracja Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC9Kaqtzn5veYgNfilJVjtVvcQ-FDuxMS0",
    authDomain: "losowaniepulavue.firebaseapp.com",
    projectId: "losowaniepulavue",
    storageBucket: "losowaniepulavue.appspot.com",
    messagingSenderId: "336274214313",
    appId: "1:336274214313:web:f0a1f9838b952fe62bc8b8",
    measurementId: "G-4D188Z7KZ6"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();


  const hiddenText = document.getElementById('hiddenText');
  const losujBtn = document.getElementById('losujBtn');
  const wynik = document.getElementById('wynik');
  const maszyna = document.getElementById('maszyna');
  const wylosowaneZdjecie = document.getElementById('wylosowaneZdjecie');
  const osobySelect = document.getElementById('osobySelect');
  const dalejBtn = document.getElementById('dalejBtn');
  const selfText = document.getElementById('selectSelf');
  const zalogujBtn = document.getElementById('zalogujBtn');
  const zalogujForm = document.getElementById('loginForm');
  const addForm = document.getElementById('addForm');

  let wybranaOsoba = "";

  osobySelect.addEventListener('change', (event) => {
    wybranaOsoba = event.target.value;
    dalejBtn.style.display = 'block';
  });

  getOsobyLosujace();


  async function getOsobyLosujace () {
    let osoby = [];
    await db.collection("osobylosujace").where("name", "!=", "Test").get().then((querySnapshot) => {
      querySnapshot.forEach((doc) => {
        const option = document.createElement('option');
        option.value = doc.data().name;
        option.text = doc.data().name;
        osobySelect.appendChild(option);
        osoby.push(doc.data().name);
      });
    });
    if (osoby.length > 0) {
      wybranaOsoba = osoby[0];
    }
  }

  function openLoginForm() {
    let item = document.getElementById("loginForm");
    if (item.style.display === 'block') {
      item.style.display = 'none';
    } else {
      item.style.display = 'block';
    }
  }

  hiddenText.addEventListener('click', () =>  {
    if (zalogujBtn.style.display === 'block') {
      zalogujBtn.style.display = 'none';
      zalogujForm.style.display = 'none';
    } else {
      zalogujBtn.style.display = 'block';
    }
  })

  dalejBtn.addEventListener('click', () =>  {
    dalejBtn.style.display = 'none';
    osobySelect.style.display = 'none';
    losujBtn.style.display = 'block';
    selfText.style.display = 'none';
  })

  //DODAWANIE DO BAZY
  document.getElementById("addInputBtn").addEventListener("click", addInput);
  document.getElementById("saveBtn").addEventListener("click", saveToFirestore);

  function addInput() {
    var inputContainer = document.getElementById("inputContainer");
    var newInput = document.createElement("input");
    newInput.type = "text";
    newInput.className = "personInput";
    inputContainer.appendChild(newInput);
  }

  function saveToFirestore() {
    var selectedCollection = document.getElementById("collectionSelect").value;
    var inputs = document.getElementsByClassName("personInput");

    if (selectedCollection === 'all') {
      Array.from(inputs).forEach(input => {
        if (input.value.trim() !== "") {
          firebase.firestore().collection('osobylosujace').add({
            name: input.value
          }).then(() => {
            console.log("Osoba dodana: " + input.value);
          }).catch(error => {
            console.error("Błąd dodawania osoby: ", error);
          });
        }
      });
      Array.from(inputs).forEach(input => {
        if (input.value.trim() !== "") {
          firebase.firestore().collection('osobydolosowania').add({
            name: input.value
          }).then(() => {
            console.log("Osoba dodana: " + input.value);
          }).catch(error => {
            console.error("Błąd dodawania osoby: ", error);
          });
        }
      });
    } else {
      Array.from(inputs).forEach(input => {
        if (input.value.trim() !== "") {
          firebase.firestore().collection(selectedCollection).add({
            name: input.value
          }).then(() => {
            console.log("Osoba dodana: " + input.value);
          }).catch(error => {
            console.error("Błąd dodawania osoby: ", error);
          });
        }
      });
    }

    // Wyczyszczenie inputów
    document.getElementById("inputContainer").innerHTML = "";
  }


  //


  losujBtn.addEventListener('click', async () => {
    losujBtn.disabled = true; // Wyłącz przycisk podczas losowania
    wynik.innerText = 'Losowanie...';
    maszyna.style.display = 'block'; // Wyświetl animację maszyny

    setTimeout( async () => {
      await db.collection("osobydolosowania").where("name", "!=", "Test").get().then((querySnapshot) => {
        const osoby = [];
        querySnapshot.forEach((doc) => {
          osoby.push(doc.data().name);
        });

        if (osoby.length === 1) {
          let wylosowanaOsoba = osoby[0];
          if (wylosowanaOsoba === wybranaOsoba) {
            wynik.innerText = 'Brak osób do losowania.';
            losujBtn.style.display = 'none';
          } else {
            wynik.innerText = 'Wylosowana osoba: ' + wylosowanaOsoba;
            usunOsobeZBazy(wybranaOsoba, 1);
            usunOsobeZBazy(wylosowanaOsoba, 2);
            losujBtn.style.display = 'none';
            wylosowaneZdjecie.style.display = 'block';
          }
        } else {
          if (osoby.length > 0) {
            let wylosowanaOsoba = "";
            do {
              wylosowanaOsoba = osoby[Math.floor(Math.random() * osoby.length)];
            } while (wylosowanaOsoba === wybranaOsoba);

            wynik.innerText = 'Wylosowana osoba: ' + wylosowanaOsoba;

            usunOsobeZBazy(wybranaOsoba, 1);
            usunOsobeZBazy(wylosowanaOsoba, 2);

            losujBtn.style.display = 'none';
            wylosowaneZdjecie.style.display = 'block';
          } else {
            wynik.innerText = 'Brak osób do losowania.';
          }
        }


        maszyna.style.display = 'none'; // Ukryj animację maszyny
      });
    }, 8000); // Czas trwania animacji (8 sekund)
  });

  async function usunOsobeZBazy(osoba, type) {
    if (type === 1) {
      await db.collection("osobylosujace").where("name", "==", osoba).get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
           db.collection("osobylosujace").doc(doc.id).delete().then(() => {
            console.log("Osoba usunięta: ", osoba);
          });
        });
      });
    } else if (type === 2) {
      await db.collection("osobydolosowania").where("name", "==", osoba).get().then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          db.collection("osobydolosowania").doc(doc.id).delete().then(() => {
            console.log("Osoba usunięta: ", osoba);
          });
        });
      });
    }

  }

  function login() {
    var userEmail = document.getElementById("email_field").value;
    var userPass = document.getElementById("password_field").value;

    firebase.auth().signInWithEmailAndPassword(userEmail, userPass)
            .then((userCredential) => {
              // Logowanie udane
              var user = userCredential.user;
              addForm.style.display = 'block';
              zalogujBtn.style.display = 'none';
              document.getElementById('losowanieMain').style.display = 'none';
              document.getElementById('loginForm').style.display = 'none';
              // Możesz tutaj przekierować użytkownika lub wyświetlić powiadomienie o udanym logowaniu
            })
            .catch((error) => {
              var errorCode = error.code;
              var errorMessage = error.message;
              // Obsługa błędów, np. użytkownik nie istnieje, złe hasło itd.
              alert(errorMessage);
            });
  }
</script>
</body>
</html>
